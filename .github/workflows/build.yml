name: Build Android APK

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          git zip unzip openjdk-17-jdk python3-pip \
          autoconf libtool pkg-config zlib1g-dev \
          libncurses5-dev libncursesw5-dev libtinfo6 \
          cmake libffi-dev libssl-dev automake libltdl-dev
    
    - name: Install Python dependencies
      run: |
        pip install --upgrade pip
        pip install buildozer==1.5.0 cython==0.29.36
    
    - name: Download Chinese font
      run: |
        if [ ! -f msyh.ttf ]; then
          wget -O msyh.ttf "https://github.com/lxgw/LxgwWenKai/releases/download/v1.315/LXGWWenKai-Regular.ttf"
        fi
    
    - name: Setup Android SDK/NDK (Fix SDK root issue)
      run: |
        # 定义核心路径
        SDK_ROOT="$HOME/.buildozer/android/platform/android-sdk"
        NDK_ROOT="$HOME/.buildozer/android/platform/android-ndk-r25b"
        
        # 1. 创建标准SDK目录结构 (cmdline-tools/latest 层级)
        mkdir -p "$SDK_ROOT/cmdline-tools"
        cd "$SDK_ROOT/cmdline-tools"
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip
        unzip -q commandlinetools-linux-9477386_latest.zip
        mv cmdline-tools latest  # 关键：形成 cmdline-tools/latest
        
        # 2. 下载并解压NDK r25b (buildozer兼容版本)
        cd "$HOME/.buildozer/android/platform"
        wget -q https://dl.google.com/android/repository/android-ndk-r25b-linux.zip
        unzip -q android-ndk-r25b-linux.zip
        
        # 3. 创建兼容软链 (适配buildozer旧路径识别)
        mkdir -p "$SDK_ROOT/tools/bin"
        ln -sf "$SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" "$SDK_ROOT/tools/bin/sdkmanager"
        ln -sf "$SDK_ROOT/cmdline-tools/latest/bin/avdmanager" "$SDK_ROOT/tools/bin/avdmanager" 2>/dev/null || true
        
        # 4. 接受SDK许可并安装组件 (显式指定--sdk_root)
        export PATH="$SDK_ROOT/cmdline-tools/latest/bin:$PATH"
        yes | sdkmanager --sdk_root="$SDK_ROOT" --licenses || true
        sdkmanager --sdk_root="$SDK_ROOT" \
          "platform-tools" \
          "platforms;android-33" \
          "build-tools;33.0.0" \
          "ndk;25.2.9519653"
        
        # 5. 导出环境变量供后续步骤使用
        echo "ANDROID_SDK_ROOT=$SDK_ROOT" >> $GITHUB_ENV
        echo "ANDROID_NDK_ROOT=$NDK_ROOT" >> $GITHUB_ENV
        echo "ANDROID_HOME=$SDK_ROOT" >> $GITHUB_ENV
    
    - name: Create buildozer.spec (关键配置)
      run: |
        cat > buildozer.spec << EOF
[app]
title = 我的电视
package.name = mytvplayer
package.domain = org.mytv
source.dir = .
source.include_exts = py,png,jpg,ttf
source.include_files = msyh.ttf
requirements = python3,kivy==2.2.1,pyjnius,urllib3,ssl
android.api = 33
android.ndk = 25b
android.ndk_path = $ANDROID_NDK_ROOT
android.sdk_path = $ANDROID_SDK_ROOT
android.build_tools = 33.0.0
android.permissions = INTERNET,ACCESS_NETWORK_STATE,OPEN_EXTERNAL_FILE
android.add_assets = msyh.ttf
android.icon = @DEFAULT
android.libs = libpython3.10.so
android.arch = arm64-v8a,x86_64
p4a.branch = master
p4a.local_recipes = .

[buildozer]
log_level = 2
warn_on_root = 1
EOF
    
    - name: Build APK
      run: |
        # 清理旧缓存 + 构建APK
        buildozer android clean
        buildozer android debug
    
    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: mytv-apk
        path: bin/*.apk
