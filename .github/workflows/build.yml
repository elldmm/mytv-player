name: Build Android APK

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-22.04  # 使用 Ubuntu 22.04 更稳定
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y git zip unzip openjdk-17-jdk python3-pip autoconf libtool pkg-config zlib1g-dev libncurses5-dev libncursesw5-dev libtinfo6 cmake libffi-dev libssl-dev automake libltdl-dev
    
    - name: Install buildozer and cython
      run: |
        pip install --upgrade pip
        pip install buildozer cython
    
    - name: Download Chinese font
      run: |
        if [ ! -f msyh.ttf ]; then
          wget -O msyh.ttf "https://github.com/lxgw/LxgwWenKai/releases/download/v1.315/LXGWWenKai-Regular.ttf"
        fi
    
    - name: Build APK
      run: |
        # 设置环境变量避免交互式提示
        export BUILDOZER_WARN_ON_ROOT=0
        buildozer android debug 2>&1 | tee build.log || (
          echo "Build failed, checking log..."
          tail -100 build.log
          exit 1
        )
      env:
        ANDROID_SDK_HOME: ${{ runner.temp }}/android-sdk
    
    - name: Upload APK
      uses: actions/upload-artifact@v4
      if: always()  # 即使失败也上传日志
      with:
        name: mytv-apk
        path: |
          bin/*.apk
          build.log
