name: Build Android APK

on: [push, pull_request]

jobs:
 build:
   runs-on: ubuntu-latest
   
   steps:
   - uses: actions/checkout@v4
   
   - name: Set up Python
     uses: actions/setup-python@v5
     with:
       python-version: '3.10'
   
   - name: Install dependencies
     run: |
       sudo apt-get update
       sudo apt-get install -y build-essential libffi-dev python3-dev openjdk-17-jdk unzip wget
       pip install buildozer cython
       pip install --upgrade pip
   
   - name: Setup Android SDK manually
     run: |
       ANDROID_SDK_ROOT="$HOME/.buildozer/android/platform/android-sdk"
       mkdir -p "$ANDROID_SDK_ROOT/cmdline-tools/latest"
       cd "$ANDROID_SDK_ROOT"
       
       wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip -O cmdline-tools.zip
       unzip -q cmdline-tools.zip
       
       mv cmdline-tools/bin "$ANDROID_SDK_ROOT/cmdline-tools/latest/"
       mv cmdline-tools/lib "$ANDROID_SDK_ROOT/cmdline-tools/latest/"
       mv cmdline-tools/NOTICE.txt "$ANDROID_SDK_ROOT/cmdline-tools/latest/" 2>/dev/null || true
       mv cmdline-tools/source.properties "$ANDROID_SDK_ROOT/cmdline-tools/latest/" 2>/dev/null || true
       rm -rf cmdline-tools cmdline-tools.zip
       
       export ANDROID_SDK_ROOT="$ANDROID_SDK_ROOT"
       export PATH="$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$ANDROID_SDK_ROOT/platform-tools:$PATH"
       
       mkdir -p "$ANDROID_SDK_ROOT/licenses"
       echo "d56f5187479451eabf01fb78af6dfcb131a6481e" > "$ANDROID_SDK_ROOT/licenses/android-sdk-license"
       echo "84831b9409646a918e30573bab4c9c91346d8abd" > "$ANDROID_SDK_ROOT/licenses/android-sdk-preview-license"
       
       yes | sdkmanager --licenses > /dev/null 2>&1
       sdkmanager --verbose "platform-tools" "build-tools;33.0.2" "platforms;android-33"
     shell: /usr/bin/bash -e {0}
   
   - name: Build Android APK
     run: |
       export JAVA_OPTS="-Xmx4g -XX:+UseG1GC"
       export GRADLE_OPTS="-Xmx4g -XX:MaxMetaspaceSize=512m"
       export ANDROID_SDK_ROOT="$HOME/.buildozer/android/platform/android-sdk"
       export PATH="$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$ANDROID_SDK_ROOT/platform-tools:$PATH"
       
       echo "ANDROID_SDK_ROOT: $ANDROID_SDK_ROOT"
       echo "PATH: $PATH"
       which sdkmanager || echo "sdkmanager not found!"
       
       buildozer android debug -v
     shell: /usr/bin/bash -e {0}
   
   - name: Upload APK
     uses: actions/upload-artifact@v4
     with:
       name: android-apk
       path: bin/*.apk
       if-no-files-found: warn
