- name: Setup Android SDK and NDK (修复路径+显式指定SDK_ROOT)
  run: |
    # 1. 定义核心路径（全程统一）
    SDK_ROOT="$HOME/.buildozer/android/platform/android-sdk"
    NDK_ROOT="$HOME/.buildozer/android/platform/android-ndk-r25b"
    
    # 2. 创建标准SDK目录结构（严格遵循android-sdk/cmdline-tools/latest层级）
    mkdir -p "$SDK_ROOT/cmdline-tools"
    cd "$SDK_ROOT/cmdline-tools"
    
    # 3. 下载并解压cmdline-tools到正确位置
    wget -q https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip
    unzip -q commandlinetools-linux-9477386_latest.zip
    # 关键：将解压后的cmdline-tools移动到latest（形成cmdline-tools/latest）
    mv cmdline-tools latest
    
    # 4. 下载并解压NDK（无需移动，解压即正确路径）
    cd "$HOME/.buildozer/android/platform"
    wget -q https://dl.google.com/android/repository/android-ndk-r25b-linux.zip
    unzip -q android-ndk-r25b-linux.zip
    
    # 5. 创建兼容软链（适配buildozer旧版路径识别）
    mkdir -p "$SDK_ROOT/tools/bin"
    ln -sf "$SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" "$SDK_ROOT/tools/bin/sdkmanager"
    ln -sf "$SDK_ROOT/cmdline-tools/latest/bin/avdmanager" "$SDK_ROOT/tools/bin/avdmanager" 2>/dev/null || true
    
    # 6. 接受许可+安装组件（核心：显式指定--sdk_root，避免识别失败）
    export PATH="$SDK_ROOT/cmdline-tools/latest/bin:$PATH"
    yes | sdkmanager --sdk_root="$SDK_ROOT" --licenses || true
    sdkmanager --sdk_root="$SDK_ROOT" \
      "platform-tools" \
      "platforms;android-33" \
      "build-tools;33.0.0" \
      "ndk;25.2.9519653"
    
    # 7. 导出环境变量（供后续buildozer使用）
    echo "ANDROID_SDK_ROOT=$SDK_ROOT" >> $GITHUB_ENV
    echo "ANDROID_NDK_ROOT=$NDK_ROOT" >> $GITHUB_ENV
    echo "ANDROID_HOME=$SDK_ROOT" >> $GITHUB_ENV
