name: Build Android APK

on: [push, pull_request]

jobs:
 build:
   runs-on: ubuntu-latest
   env:
     ANDROID_SDK_ROOT: ${{ github.workspace }}/.buildozer/android/platform/android-sdk
     ANDROID_NDK_ROOT: ${{ github.workspace }}/.buildozer/android/platform/android-ndk-r25b
     JAVA_HOME: /usr/lib/jvm/temurin-17-jdk-amd64
   
   steps:
   - uses: actions/checkout@v4
   
   - name: Set up Python
     uses: actions/setup-python@v5
     with:
       python-version: '3.10'
       cache: 'pip'
   
   - name: Install system dependencies
     run: |
       sudo apt-get update && sudo apt-get install -y \
         build-essential libffi-dev python3-dev openjdk-17-jdk unzip wget \
         libncurses5 libncurses5-dev libstdc++6 lib32z1
       pip install --upgrade pip
       pip install buildozer cython==0.29.36
   
   - name: Setup Android SDK/NDK
     run: |
       # Create SDK directory
       mkdir -p $ANDROID_SDK_ROOT/cmdline-tools
       cd $ANDROID_SDK_ROOT/cmdline-tools
       
       # Download & extract cmdline-tools
       wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip -O cmdline-tools.zip
       unzip -q cmdline-tools.zip
       mv cmdline-tools latest
       rm cmdline-tools.zip
       
       # Set PATH
       export PATH=$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$ANDROID_SDK_ROOT/platform-tools:$PATH
       
       # Accept licenses
       mkdir -p $ANDROID_SDK_ROOT/licenses
       echo "d56f5187479451eabf01fb78af6dfcb131a6481e" > $ANDROID_SDK_ROOT/licenses/android-sdk-license
       echo "84831b9409646a918e30573bab4c9c91346d8abd" > $ANDROID_SDK_ROOT/licenses/android-sdk-preview-license
       
       # Install SDK components
       $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager --sdk_root=$ANDROID_SDK_ROOT --licenses < /dev/null
       $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager --sdk_root=$ANDROID_SDK_ROOT "platform-tools" "build-tools;33.0.2" "platforms;android-33"
       
       # Download & extract NDK (required by buildozer)
       mkdir -p $ANDROID_NDK_ROOT
       cd $ANDROID_NDK_ROOT/..
       wget -q https://dl.google.com/android/repository/android-ndk-r25b-linux.zip -O ndk.zip
       unzip -q ndk.zip
       rm ndk.zip
     shell: /usr/bin/bash -e {0}
   
   - name: Configure buildozer
     run: |
       echo "[app]
title = MyTVPlayer
package.name = mytvplayer
package.domain = org.example
source.dir = .
source.include_exts = py,png,jpg,kv,atlas
version = 0.1
osx.python_version = 3
osx.kivy_version = 2.1.0
android.ndk = 25b
android.sdk = 33
android.api = 33
android.ndk_path = $ANDROID_NDK_ROOT
android.sdk_path = $ANDROID_SDK_ROOT
android.add_android_jar = False
android.arch = arm64-v8a
android.allow_backup = True
android.permissions = INTERNET
p4a.branch = master
p4a.bootstrap = sdl2
p4a.setup_py_dir = .
" > buildozer.spec
   
   - name: Build Android APK
     run: |
       export JAVA_OPTS="-Xmx4g -XX:+UseG1GC"
       export GRADLE_OPTS="-Xmx4g -XX:MaxMetaspaceSize=512m"
       export PATH=$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$ANDROID_SDK_ROOT/platform-tools:$ANDROID_NDK_ROOT:$PATH
       
       # Verify dependencies
       which python3
       which javac
       which sdkmanager
       $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager --list
       
       # Build APK
       buildozer android debug -v
     shell: /usr/bin/bash -e {0}
   
   - name: Upload APK
     uses: actions/upload-artifact@v4
     with:
       name: android-apk
       path: |
         bin/*.apk
         bin/*.log
       if-no-files-found: warn
