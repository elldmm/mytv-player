name: Build Android APK

on: [push, pull_request]

jobs:
 build:
   runs-on: ubuntu-latest
   
   steps:
   - uses: actions/checkout@v4
   
   - name: Set up Python
     uses: actions/setup-python@v5
     with:
       python-version: '3.10'
   
   - name: Install dependencies
     run: |
       sudo apt-get update
       sudo apt-get install -y build-essential libffi-dev python3-dev openjdk-17-jdk unzip wget
       pip install buildozer cython
   
   - name: Setup Android SDK manually
     run: |
       ANDROID_SDK_ROOT="$HOME/.buildozer/android/platform/android-sdk"
   
       mkdir -p "$ANDROID_SDK_ROOT/tools/bin"
       ln -s "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" "$ANDROID_SDK_ROOT/tools/bin/sdkmanager"
       
    
       mkdir -p "$ANDROID_SDK_ROOT/cmdline-tools"
       cd "$ANDROID_SDK_ROOT/cmdline-tools"
       wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip -O cmdline-tools.zip
       unzip -q cmdline-tools.zip
       mv cmdline-tools latest
       rm -rf cmdline-tools.zip
       
     
       export ANDROID_SDK_ROOT="$ANDROID_SDK_ROOT"
       export PATH="$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$ANDROID_SDK_ROOT/platform-tools:$PATH"
       export JAVA_HOME="/usr/lib/jvm/temurin-17-jdk-amd64"
       
    
       mkdir -p "$ANDROID_SDK_ROOT/licenses"
       echo "d56f5187479451eabf01fb78af6dfcb131a6481e" > "$ANDROID_SDK_ROOT/licenses/android-sdk-license"
       echo "84831b9409646a918e30573bab4c9c91346d8abd" > "$ANDROID_SDK_ROOT/licenses/android-sdk-preview-license"
       
    
       $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager --licenses --sdk_root=$ANDROID_SDK_ROOT < /dev/null
       $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager --verbose "platform-tools" "build-tools;33.0.0" "platforms;android-33" --sdk_root=$ANDROID_SDK_ROOT
     shell: /usr/bin/bash -e {0}
   
   - name: Build Android APK
     run: |
       export JAVA_OPTS="-Xmx4g -XX:+UseG1GC"
       export GRADLE_OPTS="-Xmx4g -XX:MaxMetaspaceSize=512m"
       export ANDROID_SDK_ROOT="$HOME/.buildozer/android/platform/android-sdk"
       export PATH="$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$ANDROID_SDK_ROOT/platform-tools:$PATH"
       export JAVA_HOME="/usr/lib/jvm/temurin-17-jdk-amd64"
       
       buildozer android debug
     shell: /usr/bin/bash -e {0}
   
   - name: Upload APK
     uses: actions/upload-artifact@v4
     with:
       name: android-apk
       path: bin/*.apk
